import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.nio.ByteBuffer;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Scanner;

public class Question_02_Server {

	static DatagramSocket myUDPSocket;
	static int port, bufferSize;
	static byte[] buffer;

	// handle getting the date and time
	static Date currentDate;
	static DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

	static Scanner keyboardInput = new Scanner(System.in);

	public static void getInfo() {

		do {

			System.out.print("What port do you want to use? ");
			port = keyboardInput.nextInt();

		} while (port <= 0);

		do {

			System.out.print("How big of a buffer do you want? ");
			bufferSize = keyboardInput.nextInt();

		} while (bufferSize <= 0);

		currentDate = new Date();

	}

	public static void startServer() throws IOException {

		myUDPSocket = new DatagramSocket(port);

		buffer = new byte[bufferSize];

		while (true) {

			DatagramPacket incomingMessage = new DatagramPacket(buffer,
					bufferSize);
			myUDPSocket.receive(incomingMessage);

			Long clientTime = bytesToLong(incomingMessage.getData());
			
			//Long timeDifference = currentDate.getTime() - clientTime;
			
			byte[] replyData = clientTime.getBytes();//Long.toString(timeDifference).getBytes();
			
			DatagramPacket outgoingMessage = new DatagramPacket(replyData,
					replyData.length, incomingMessage.getAddress(),
					incomingMessage.getPort());

			myUDPSocket.send(outgoingMessage);

		}
	}
	
	static private long bytesToLong(byte[] bytes) {
	    ByteBuffer buffer = ByteBuffer.allocate(Long.BYTES);
	    buffer.put(bytes);
	    buffer.flip();//need flip 
	    return buffer.getLong();
	}

	/**
	 * @param args
	 */
	public static void main(String[] args) {

		getInfo();

		try {
			startServer();

		} catch (IOException e) {

			System.err.println(e.getMessage());

		} finally {

			myUDPSocket.close();
		}

	}

}
